<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:TwentyFortyEight.ViewModels;assembly=TwentyFortyEight.ViewModels"
             xmlns:components="clr-namespace:TwentyFortyEight.Maui.Components"
             xmlns:behaviors="clr-namespace:TwentyFortyEight.Maui.Behaviors"
             xmlns:converters="clr-namespace:TwentyFortyEight.Maui.Converters"
             xmlns:core="clr-namespace:TwentyFortyEight.Core;assembly=TwentyFortyEight.Core"
             xmlns:strings="clr-namespace:TwentyFortyEight.Maui.Resources.Strings"
             xmlns:skia="clr-namespace:SkiaSharp.Views.Maui.Controls;assembly=SkiaSharp.Views.Maui.Controls"
             x:Class="TwentyFortyEight.Maui.MainPage"
             x:DataType="local:GameViewModel"
             Background="{AppThemeBinding Light={StaticResource GamePageBackgroundLight}, Dark={StaticResource GamePageBackgroundDark}}">

    <ContentPage.Resources>
        <converters:FontSizeScaleConverter x:Key="FontSizeScaleConverter" />
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem
            x:Name="ToolbarLeaderboardButton"
            AutomationId="ToolbarLeaderboardButton"
            Text="{x:Static strings:AppStrings.LeaderboardToolbarText}"
            Command="{Binding ShowLeaderboardCommand}"
            Order="Secondary"
            Priority="0" />
        <ToolbarItem
            x:Name="ToolbarAchievementsButton"
            AutomationId="ToolbarAchievementsButton"
            Text="{x:Static strings:AppStrings.AchievementsToolbarText}"
            Command="{Binding ShowAchievementsCommand}"
            Order="Secondary"
            Priority="1" />
        <ToolbarItem
            x:Name="ToolbarSettingsButton"
            AutomationId="ToolbarSettingsButton"
            Text="{x:Static strings:AppStrings.Settings}"
            Command="{Binding OpenSettingsCommand}"
            Order="Secondary"
            Priority="2" />
        <ToolbarItem
            x:Name="ToolbarHowToPlayButton"
            AutomationId="ToolbarHowToPlayButton"
            Text="{x:Static strings:AppStrings.HowToPlay}"
            Command="{Binding ShowHowToPlayCommand}"
            Order="Secondary"
            Priority="3" />
    </ContentPage.ToolbarItems>

    <Grid x:Name="RootLayout" Padding="20" RowSpacing="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header with Title and Score -->
        <Grid x:Name="HeaderGrid" Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Border x:Name="ScoreBorder"
                    Grid.Column="1"
                    Background="{AppThemeBinding Light={StaticResource GamePanelBackgroundLight}, Dark={StaticResource GamePanelBackgroundDark}}"
                    Stroke="Transparent"
                    StrokeThickness="0"
                    Padding="20,10"
                    Margin="10,0"
                    HeightRequest="60"
                    StrokeShape="RoundRectangle 5">
                <VerticalStackLayout Spacing="0">
                    <Label x:Name="ScoreLabelText"
                           Text="{x:Static strings:AppStrings.Score}"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#eee4da, Dark=#cdc1b4}"
                           HorizontalOptions="Center" />
                    <Label x:Name="ScoreValue"
                           Text="{Binding Score}"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"
                           SemanticProperties.Description="{x:Static strings:AppStrings.CurrentScoreDescription}" />
                </VerticalStackLayout>
            </Border>

            <Border x:Name="BestScoreBorder"
                    Grid.Column="2"
                    Background="{AppThemeBinding Light={StaticResource GamePanelBackgroundLight}, Dark={StaticResource GamePanelBackgroundDark}}"
                    Stroke="Transparent"
                    StrokeThickness="0"
                    Padding="20,10"
                    HeightRequest="60"
                    StrokeShape="RoundRectangle 5">
                <VerticalStackLayout Spacing="0">
                    <Label x:Name="BestScoreLabelText"
                           Text="{x:Static strings:AppStrings.Best}"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#eee4da, Dark=#cdc1b4}"
                           HorizontalOptions="Center" />
                    <Label x:Name="BestScoreValue"
                           Text="{Binding BestScore}"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="White"
                           HorizontalOptions="Center"
                           SemanticProperties.Description="{x:Static strings:AppStrings.BestScoreDescription}" />
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!-- Status Text -->
        <Label x:Name="StatusTextLabel"
               Grid.Row="1"
               Text="{Binding StatusText}"
               FontSize="24"
               FontAttributes="Bold"
             TextColor="{StaticResource GameStatusAccent}"
               HorizontalOptions="Center"
               IsVisible="{Binding StatusText, Converter={StaticResource StringNotEmptyConverter}}" />

        <!-- Game Board -->
        <Border x:Name="BoardContainer"
                Grid.Row="2"
            Background="{AppThemeBinding Light={StaticResource GamePanelBackgroundLight}, Dark={StaticResource GamePanelBackgroundDark}}"
                Stroke="Transparent"
                StrokeThickness="0"
                Padding="10"
                VerticalOptions="Center"
                HorizontalOptions="Center"
                MaximumWidthRequest="500"
                MaximumHeightRequest="500"
                StrokeShape="RoundRectangle 10">

            <Border.Behaviors>
                <behaviors:RippleBehavior />
            </Border.Behaviors>

            <Grid>
                <!-- Grid for tiles - rows and columns are generated dynamically in code-behind -->
                <Grid x:Name="GameBoard"
                      ColumnSpacing="10"
                      RowSpacing="10"
                      SemanticProperties.Description="{x:Static strings:AppStrings.GameBoardDescription}">
                    <!-- Tiles will be added programmatically in code-behind -->
                    <!-- WidthRequest and HeightRequest are set dynamically in OnSizeAllocated for responsive scaling -->
                </Grid>
            </Grid>
        </Border>

        <!-- Controls -->
        <FlexLayout x:Name="ControlsFlexLayout"
                    Grid.Row="3"
                    Direction="Row"
                    Wrap="Wrap"
                    JustifyContent="Center"
                    AlignItems="Start"
                    AlignContent="Start"
                    Margin="0,5,0,0">

            <Button x:Name="NewGameButton"
                AutomationId="NewGameButton"
                Command="{Binding NewGameCommand}"
                Text="{x:Static strings:AppStrings.NewGame}"
                Background="{AppThemeBinding Light={StaticResource GameButtonBackgroundLight}, Dark={StaticResource GameButtonBackgroundDark}}"
                TextColor="White"
                HeightRequest="50"
                Padding="15,0"
                Margin="3,2.5"
                CornerRadius="5"
                SemanticProperties.Description="{x:Static strings:AppStrings.NewGameDescription}" />

            <Button x:Name="UndoButton"
                AutomationId="UndoButton"
                Command="{Binding UndoCommand}"
                IsEnabled="{Binding CanUndo}"
                Text="{x:Static strings:AppStrings.Undo}"
                Background="{AppThemeBinding Light={StaticResource GameButtonBackgroundLight}, Dark={StaticResource GameButtonBackgroundDark}}"
                TextColor="White"
                HeightRequest="50"
                Padding="15,0"
                Margin="3,2.5"
                CornerRadius="5"
                SemanticProperties.Description="{x:Static strings:AppStrings.UndoDescription}" />

            <Button x:Name="StatisticsButton"
                AutomationId="StatisticsButton"
                Command="{Binding OpenStatsCommand}"
                Text="{x:Static strings:AppStrings.Statistics}"
                Background="{AppThemeBinding Light={StaticResource GameButtonBackgroundLight}, Dark={StaticResource GameButtonBackgroundDark}}"
                TextColor="White"
                HeightRequest="50"
                Padding="15,0"
                Margin="3,2.5"
                CornerRadius="5"
                SemanticProperties.Description="{x:Static strings:AppStrings.StatisticsDescription}" />
        </FlexLayout>

        <!-- Game Over Modal -->
        <components:GameOverModal x:Name="GameOverModal"
                                  Grid.RowSpan="4"
                                  IsVisible="{Binding IsGameOver}"
                                  Score="{Binding Score}"
                                  BestScore="{Binding BestScore}"
                                  NewGameCommand="{Binding NewGameCommand}"
                                  ZIndex="100" />

        <!-- How To Play Modal -->
        <components:HowToPlayModal x:Name="HowToPlayModal"
                                   Grid.RowSpan="4"
                                   IsVisible="{Binding IsHowToPlayVisible}"
                                   CloseCommand="{Binding CloseHowToPlayCommand}"
                                   ZIndex="100" />
    </Grid>
</ContentPage>
